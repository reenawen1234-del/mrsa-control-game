<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MRSA Clinical Training Module</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Exo 2', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .health-bar-fill {
      transition: width 0.5s ease-out, background-color 0.3s ease;
    }
    
    .scenario-card {
      animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes slideInUp {
      from { 
        opacity: 0; 
        transform: translateY(30px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
      50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.4); }
    }
    
    .glow-effect {
      animation: glow 2s infinite;
    }
    
    .decision-btn {
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      overflow: hidden;
    }
    
    .decision-btn:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .decision-btn:hover:before {
      left: 100%;
    }
    
    .decision-btn:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .patient-card {
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      cursor: pointer;
      position: relative;
    }
    
    .patient-card:hover {
      transform: translateX(6px) scale(1.02);
    }
    
    .patient-card.active {
      border-left: 5px solid #3b82f6;
      background: linear-gradient(to right, #eff6ff, #1e293b);
    }
    
    .patient-card.active:after {
      content: '‚ñ∂';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #3b82f6;
      font-size: 18px;
    }
    
    .toast {
      animation: toastSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes toastSlide {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .modal-overlay {
      animation: fadeInOverlay 0.3s ease-out;
    }
    
    @keyframes fadeInOverlay {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      animation: modalPop 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes modalPop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .stat-box:before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 10s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .streak-badge {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }
    
    .xp-bar-container {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .xp-bar-fill {
      background: linear-gradient(90deg, #00f260, #0575e6);
      height: 100%;
      border-radius: 10px;
      transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      overflow: hidden;
    }
    
    .xp-bar-fill:after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      from { transform: translateX(-100%); }
      to { transform: translateX(100%); }
    }
    
    .category-badge {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    
    .prevention { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .identification { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
    .treatment { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white overflow-auto">
  <div id="app" class="h-full w-full flex flex-col"><!-- Header -->
   <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 border-b-2 border-yellow-400 px-6 py-4 flex-shrink-0 shadow-2xl relative overflow-hidden">
    <div class="absolute inset-0 bg-black opacity-20"></div>
    <div class="relative z-10 flex items-center justify-between">
     <div class="flex items-center gap-4">
      <div class="w-14 h-14 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
       <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
       </svg>
      </div>
      <div>
       <h1 id="module-title" class="text-2xl font-bold text-white drop-shadow-lg">MRSA Combat Training</h1>
       <p class="text-sm text-yellow-300 font-medium">Interactive Clinical Simulation Game</p>
      </div>
     </div>
     <div class="flex items-center gap-4">
      <div class="streak-badge"><span id="streak-count">0</span> <span>üî•</span>
      </div>
      <div class="stat-box" style="padding: 12px 20px; min-width: 120px;">
       <p class="text-xs opacity-80 uppercase tracking-wide">XP Points</p>
       <p id="xp-display" class="text-2xl font-bold">0</p>
      </div>
      <div class="text-right bg-black/30 px-4 py-2 rounded-lg backdrop-blur-sm">
       <p class="text-xs text-yellow-300 uppercase tracking-wide font-semibold">Ward Safety</p>
       <p id="ward-safety-header" class="text-2xl font-bold text-white">90%</p>
      </div><button onclick="resetModule()" class="px-5 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold transition-all transform hover:scale-105 shadow-lg"> üîÑ Reset </button>
     </div>
    </div>
   </header><!-- Main Content -->
   <div class="flex-1 flex overflow-hidden"><!-- Left Panel: Patient List -->
    <aside class="w-72 bg-slate-800 border-r-2 border-slate-700 flex flex-col flex-shrink-0 overflow-hidden shadow-2xl">
     <div class="p-4 border-b-2 border-indigo-500 bg-gradient-to-r from-indigo-600 to-purple-600">
      <h2 class="font-bold text-white flex items-center gap-2 text-lg">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
       </svg> Ward 4B Patients</h2>
      <p class="text-xs text-indigo-200 mt-1">Select to begin treatment</p>
     </div>
     <div class="flex-1 overflow-y-auto p-3 space-y-2" id="patient-list"><!-- Patient cards will be injected here -->
     </div>
    </aside><!-- Center Panel: Main Scenario Area -->
    <main class="flex-1 flex flex-col overflow-hidden bg-slate-900"><!-- Patient Status Bar -->
     <div class="bg-slate-800 border-b-2 border-slate-700 p-4 flex-shrink-0 shadow-lg">
      <div class="flex items-center justify-between mb-3">
       <div class="flex items-center gap-4">
        <div id="patient-avatar" class="w-16 h-16 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center border-4 border-blue-300 shadow-lg">
         <svg class="w-9 h-9 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
         </svg>
        </div>
        <div>
         <h3 id="patient-name-display" class="font-bold text-white text-xl">Select a patient</h3>
         <p id="patient-details" class="text-sm text-slate-400">Choose a patient from the left panel to begin</p>
        </div>
       </div>
       <div class="flex items-center gap-6">
        <div class="text-center bg-slate-700 px-4 py-2 rounded-lg">
         <p class="text-xs text-slate-400 uppercase tracking-wide">Status</p>
         <p id="patient-status-badge" class="text-sm font-bold text-yellow-400">‚Äî</p>
        </div>
        <div class="text-center bg-slate-700 px-4 py-2 rounded-lg">
         <p class="text-xs text-slate-400 uppercase tracking-wide">Scenario</p>
         <p id="scenario-progress" class="text-sm font-bold text-white">‚Äî / ‚Äî</p>
        </div>
       </div>
      </div><!-- Health Bar -->
      <div>
       <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-300 uppercase tracking-wide">Patient Health Status</span> <span id="health-percent" class="text-sm font-bold text-white">‚Äî</span>
       </div>
       <div class="h-4 bg-slate-700 rounded-full overflow-hidden border-2 border-slate-600">
        <div id="health-bar" class="health-bar-fill h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full" style="width: 0%"></div>
       </div>
      </div>
     </div><!-- Scenario Content -->
     <div class="flex-1 overflow-y-auto p-6 bg-gradient-to-br from-slate-900 to-slate-800">
      <div id="scenario-container" class="scenario-card max-w-4xl mx-auto"><!-- Welcome screen -->
       <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl shadow-2xl border-2 border-yellow-400 p-12 text-center relative overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-20"></div>
        <div class="relative z-10">
         <div class="w-24 h-24 bg-gradient-to-br from-yellow-300 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl">
          <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
         </div>
         <h2 class="text-3xl font-black text-white mb-4 drop-shadow-lg">MRSA Combat Training</h2>
         <p class="text-white text-lg mb-6 max-w-xl mx-auto font-medium">Select a patient from the left to start your clinical mission. Master prevention, identification, and treatment protocols to save lives and earn XP!</p>
         <div class="inline-block px-8 py-4 bg-black/30 backdrop-blur-sm border-2 border-yellow-400 rounded-xl">
          <p class="text-lg text-yellow-300 font-bold">üè• 5 Patients ‚Ä¢ üéØ Multiple Scenarios ‚Ä¢ üèÜ Earn XP &amp; Streaks</p>
         </div>
        </div>
       </div>
      </div>
     </div>
    </main><!-- Right Panel: Stats & Knowledge -->
    <aside class="w-80 bg-slate-800 border-l-2 border-slate-700 flex flex-col flex-shrink-0 overflow-hidden shadow-2xl">
     <div class="p-4 border-b-2 border-purple-500 bg-gradient-to-r from-purple-600 to-pink-600">
      <h2 class="font-bold text-white flex items-center gap-2 text-lg">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
       </svg> Patient Monitor</h2>
     </div>
     <div class="flex-1 overflow-y-auto p-4 space-y-4"><!-- Patient Vitals -->
      <div id="vitals-panel" class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-4 border-2 border-slate-600 shadow-lg">
       <h3 class="font-bold text-cyan-400 text-sm mb-3 flex items-center gap-2"><span>üíì</span> Vital Signs</h3>
       <div id="vitals-content" class="space-y-2 text-xs text-slate-300">
        <p class="text-slate-400">Select a patient to view vitals</p>
       </div>
      </div><!-- Infection Spread Monitor -->
      <div class="bg-gradient-to-br from-red-900/40 to-pink-900/40 rounded-xl p-4 border-2 border-red-500/50 shadow-lg">
       <h3 class="font-bold text-red-400 text-sm mb-3 flex items-center gap-2"><span>ü¶†</span> Infection Spread</h3>
       <div class="space-y-3">
        <div>
         <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-300 font-semibold">Ward Risk Level</span> <span id="ward-risk-percent" class="text-xs font-bold text-red-400">10%</span>
         </div>
         <div class="h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-600">
          <div id="ward-risk-bar" class="h-full bg-gradient-to-r from-yellow-500 to-red-600 rounded-full transition-all duration-500" style="width: 10%"></div>
         </div>
        </div>
        <div class="bg-slate-800/50 p-2 rounded-lg">
         <p class="text-xs text-slate-300 font-semibold mb-1">Active Cases:</p>
         <p id="active-cases" class="text-lg font-bold text-red-400">0</p>
        </div>
       </div>
      </div><!-- Patient Health Status -->
      <div id="patient-status-panel" class="bg-gradient-to-br from-blue-900/40 to-purple-900/40 rounded-xl p-4 border-2 border-blue-500/50 shadow-lg">
       <h3 class="font-bold text-blue-400 text-sm mb-3 flex items-center gap-2"><span>üìã</span> Patient Status</h3>
       <div id="patient-status-content" class="space-y-2 text-xs text-slate-300">
        <p class="text-slate-400">Select a patient to view status</p>
       </div>
      </div><!-- Performance Stats -->
      <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-4 shadow-lg">
       <h3 class="font-bold text-white text-sm mb-3 uppercase tracking-wide">üìä Performance</h3>
       <div class="space-y-2">
        <div class="flex justify-between items-center"><span class="text-white text-xs font-semibold">Optimal Decisions:</span> <span id="optimal-count" class="text-white text-lg font-bold">0</span>
        </div>
        <div class="flex justify-between items-center"><span class="text-white text-xs font-semibold">Total Decisions:</span> <span id="total-decisions" class="text-white text-lg font-bold">0</span>
        </div>
        <div class="flex justify-between items-center"><span class="text-white text-xs font-semibold">Success Rate:</span> <span id="success-rate" class="text-white text-lg font-bold">0%</span>
        </div>
       </div>
      </div><!-- Level Progress -->
      <div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl p-4 shadow-lg">
       <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold text-white text-sm uppercase tracking-wide">Level <span id="level-display">1</span></h3><span class="text-xs text-purple-200 font-semibold"><span id="xp-current">0</span>/<span id="xp-needed">100</span> XP</span>
       </div>
       <div class="xp-bar-container">
        <div id="xp-bar" class="xp-bar-fill" style="width: 0%"></div>
       </div>
      </div><!-- MRSA Quick Reference -->
      <div class="bg-slate-700 rounded-xl p-4 border-2 border-slate-600">
       <h3 class="font-bold text-yellow-400 text-sm mb-3 flex items-center gap-2"><span>üìö</span> MRSA Quick Reference</h3>
       <div class="space-y-3">
        <div class="bg-slate-800 p-2 rounded-lg">
         <p class="text-xs text-slate-300 font-semibold mb-1">üõ°Ô∏è Prevention Key:</p>
         <p class="text-xs text-slate-400">Hand hygiene, contact precautions, environmental cleaning</p>
        </div>
        <div class="bg-slate-800 p-2 rounded-lg">
         <p class="text-xs text-slate-300 font-semibold mb-1">üîç Identification:</p>
         <p class="text-xs text-slate-400">PCR screening, culture sensitivity, early symptom detection</p>
        </div>
        <div class="bg-slate-800 p-2 rounded-lg">
         <p class="text-xs text-slate-300 font-semibold mb-1">üíä Treatment:</p>
         <p class="text-xs text-slate-400">Vancomycin IV, appropriate dosing, duration 4-6 weeks</p>
        </div>
       </div>
      </div><!-- Achievements -->
      <div class="bg-slate-700 rounded-xl p-4 border-2 border-slate-600">
       <h3 class="font-bold text-yellow-400 text-sm mb-3 flex items-center gap-2"><span>üèÜ</span> Achievements</h3>
       <div id="achievements-list" class="space-y-2 text-xs text-slate-400">
        <p>Complete scenarios to unlock achievements!</p>
       </div>
      </div>
     </div>
    </aside>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div><!-- Feedback Modal -->
   <div id="feedback-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden modal-overlay">
    <div class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden border-2 border-slate-600">
     <div id="modal-header" class="p-5 border-b-2">
      <h3 id="modal-title" class="text-xl font-bold"></h3>
     </div>
     <div class="p-6">
      <p id="modal-message" class="text-slate-300 leading-relaxed mb-4"></p>
      <div id="modal-xp-gain" class="mb-4 p-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg text-center hidden">
       <p class="text-white font-bold text-lg">+<span id="xp-earned">0</span> XP</p>
      </div>
      <div id="modal-details" class="p-4 bg-slate-700 rounded-lg border-2 border-slate-600">
       <h4 class="font-bold text-yellow-400 text-sm mb-2">üí° Clinical Insight:</h4>
       <p id="modal-insight" class="text-sm text-slate-300"></p>
      </div>
     </div>
     <div class="p-4 border-t-2 border-slate-700 bg-slate-900 flex justify-between"><button id="undo-btn" onclick="undoDecision()" class="px-5 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-bold transition-all transform hover:scale-105"> ‚Ü© Undo &amp; Try Again </button> <button onclick="closeModal()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-lg text-sm font-bold transition-all transform hover:scale-105"> Continue ‚Üí </button>
     </div>
    </div>
   </div><!-- Completion Modal -->
   <div id="completion-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden modal-overlay">
    <div class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden border-2 border-yellow-400">
     <div class="p-6 bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white text-center relative overflow-hidden">
      <div class="absolute inset-0 bg-black opacity-20"></div>
      <div class="relative z-10">
       <div class="w-20 h-20 bg-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl">
        <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
       </div>
       <h3 class="text-3xl font-black drop-shadow-lg">Mission Complete!</h3>
      </div>
     </div>
     <div class="p-6">
      <div class="grid grid-cols-3 gap-3 mb-6">
       <div class="text-center p-4 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg">
        <p class="text-3xl font-black text-white" id="final-ward-safety">0%</p>
        <p class="text-xs text-white font-semibold">Ward Safety</p>
       </div>
       <div class="text-center p-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl shadow-lg">
        <p class="text-3xl font-black text-white" id="optimal-decisions">0</p>
        <p class="text-xs text-white font-semibold">Optimal</p>
       </div>
       <div class="text-center p-4 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl shadow-lg">
        <p class="text-3xl font-black text-white" id="final-xp">0</p>
        <p class="text-xs text-white font-semibold">Total XP</p>
       </div>
      </div>
      <div id="completion-summary" class="text-sm text-slate-300 text-center mb-4"></div>
      <div id="final-rank" class="text-center p-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl">
       <p class="text-2xl font-black text-white">Rank: <span id="rank-text">Novice</span></p>
      </div>
     </div>
     <div class="p-4 border-t-2 border-slate-700 bg-slate-900"><button onclick="resetModule()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg"> üîÑ Play Again </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      module_title: "MRSA Combat Training",
      background_color: "#0f172a",
      primary_color: "#8b5cf6",
      text_color: "#ffffff",
      accent_color: "#f59e0b"
    };

    // Game state
    let gameState = {
      currentPatientId: null,
      currentScenarioIndex: 0,
      wardSafety: 90,
      patientStates: {},
      decisions: [],
      lastDecision: null,
      xp: 0,
      level: 1,
      streak: 0,
      achievements: []
    };

    // XP and Level system
    function getXPForLevel(level) {
      return level * 100;
    }

    function addXP(amount) {
      gameState.xp += amount;
      updateXPDisplay();
      checkLevelUp();
    }

    function updateXPDisplay() {
      const xpNeeded = getXPForLevel(gameState.level);
      const xpCurrent = gameState.xp % xpNeeded;
      const percentage = (xpCurrent / xpNeeded) * 100;
      
      document.getElementById('xp-display').textContent = gameState.xp;
      document.getElementById('xp-current').textContent = xpCurrent;
      document.getElementById('xp-needed').textContent = xpNeeded;
      document.getElementById('xp-bar').style.width = percentage + '%';
      document.getElementById('level-display').textContent = gameState.level;
    }

    function checkLevelUp() {
      const xpNeeded = getXPForLevel(gameState.level);
      if (gameState.xp >= xpNeeded * gameState.level) {
        gameState.level++;
        showToast('üéâ Level Up! Now Level ' + gameState.level, 'success');
        updateXPDisplay();
      }
    }

    function updateStreak(isOptimal) {
      if (isOptimal) {
        gameState.streak++;
      } else {
        gameState.streak = 0;
      }
      document.getElementById('streak-count').textContent = gameState.streak;
      
      if (gameState.streak >= 5 && gameState.achievements.indexOf('hot-streak') === -1) {
        gameState.achievements.push('hot-streak');
        showToast('üèÜ Achievement: Hot Streak! (5 optimal decisions)', 'success');
      }
    }

    function updateStats() {
      const optimalCount = gameState.decisions.filter(function(d) { return d.outcome === 'optimal'; }).length;
      const totalCount = gameState.decisions.length;
      const successRate = totalCount > 0 ? Math.round((optimalCount / totalCount) * 100) : 0;
      
      document.getElementById('optimal-count').textContent = optimalCount;
      document.getElementById('total-decisions').textContent = totalCount;
      document.getElementById('success-rate').textContent = successRate + '%';
    }

    // Calculate infection spread metrics
    function updateInfectionSpread() {
      const wardRisk = 100 - gameState.wardSafety;
      let activeCases = 0;
      
      for (let i = 0; i < patients.length; i++) {
        const p = patients[i];
        const state = gameState.patientStates[p.id];
        if (state.health < 70 || p.mrsaStatus.indexOf('MRSA+') !== -1 || p.mrsaStatus.indexOf('Confirmed') !== -1) {
          activeCases++;
        }
      }
      
      document.getElementById('ward-risk-percent').textContent = wardRisk + '%';
      document.getElementById('ward-risk-bar').style.width = wardRisk + '%';
      document.getElementById('active-cases').textContent = activeCases;
    }

    // Update patient vitals display
    function updateVitalsDisplay(patient) {
      if (!patient) {
        document.getElementById('vitals-content').innerHTML = '<p class="text-slate-400">Select a patient to view vitals</p>';
        return;
      }
      
      const state = gameState.patientStates[patient.id];
      
      let temp = '37.2¬∞C';
      let hr = '82 bpm';
      let bp = '128/78';
      let rr = '16';
      let spo2 = '98%';
      
      if (state.health < 50) {
        temp = '38.8¬∞C';
        hr = '112 bpm';
        bp = '142/88';
        rr = '22';
        spo2 = '94%';
      } else if (state.health < 70) {
        temp = '38.1¬∞C';
        hr = '95 bpm';
        bp = '135/82';
        rr = '18';
        spo2 = '96%';
      }
      
      const tempColor = state.health < 70 ? 'text-orange-400' : 'text-green-400';
      const hrColor = state.health < 70 ? 'text-orange-400' : 'text-cyan-400';
      const spo2Color = state.health < 60 ? 'text-red-400' : (state.health < 80 ? 'text-orange-400' : 'text-green-400');
      const rrColor = state.health < 70 ? 'text-orange-400' : 'text-cyan-400';
      
      document.getElementById('vitals-content').innerHTML = 
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">Temperature:</span>' +
        '<span class="font-bold ' + tempColor + '">' + temp + '</span>' +
        '</div>' +
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">Heart Rate:</span>' +
        '<span class="font-bold ' + hrColor + '">' + hr + '</span>' +
        '</div>' +
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">Blood Pressure:</span>' +
        '<span class="font-bold text-cyan-400">' + bp + '</span>' +
        '</div>' +
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">Resp. Rate:</span>' +
        '<span class="font-bold ' + rrColor + '">' + rr + '/min</span>' +
        '</div>' +
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">SpO‚ÇÇ:</span>' +
        '<span class="font-bold ' + spo2Color + '">' + spo2 + '</span>' +
        '</div>';
    }

    // Update patient status display
    function updatePatientStatusDisplay(patient) {
      if (!patient) {
        document.getElementById('patient-status-content').innerHTML = '<p class="text-slate-400">Select a patient to view status</p>';
        return;
      }
      
      const state = gameState.patientStates[patient.id];
      const scenario = patient.scenarios[state.scenarioIndex];
      
      let statusColor = 'text-green-400';
      let statusText = 'Stable';
      
      if (state.health < 40) {
        statusColor = 'text-red-400';
        statusText = 'Critical';
      } else if (state.health < 60) {
        statusColor = 'text-orange-400';
        statusText = 'Declining';
      } else if (state.health < 80) {
        statusColor = 'text-yellow-400';
        statusText = 'Improving';
      }
      
      const riskColorMap = {
        'low': 'text-emerald-400',
        'moderate': 'text-amber-400',
        'high': 'text-red-400'
      };
      const riskColor = riskColorMap[patient.riskLevel];
      
      let html = '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">Condition:</span>' +
        '<span class="font-bold ' + statusColor + '">' + statusText + '</span>' +
        '</div>' +
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">MRSA Status:</span>' +
        '<span class="font-bold ' + riskColor + '">' + patient.mrsaStatus.split(' -')[0] + '</span>' +
        '</div>' +
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">Risk Level:</span>' +
        '<span class="font-bold ' + riskColor + '">' + patient.riskLevel.toUpperCase() + '</span>' +
        '</div>' +
        '<div class="flex justify-between items-center">' +
        '<span class="text-slate-400">Progress:</span>' +
        '<span class="font-bold text-purple-400">' + state.scenarioIndex + '/' + patient.scenarios.length + '</span>' +
        '</div>';
      
      if (scenario) {
        html += '<div class="mt-2 pt-2 border-t border-slate-600">' +
          '<span class="text-slate-400 text-xs">Current Phase:</span>' +
          '<span class="font-bold text-xs text-purple-400 ml-2">' + scenario.category.toUpperCase() + '</span>' +
          '</div>';
      }
      
      document.getElementById('patient-status-content').innerHTML = html;
    }

    // Patient database with expanded scenarios
    const patients = [
      {
        id: 1,
        name: "Sarah Martinez",
        age: 52,
        room: "410",
        admission: "Post-operative (Knee Replacement)",
        baseHealth: 80,
        mrsaStatus: "Unknown - High Risk",
        riskLevel: "high",
        scenarios: [
          {
            id: "sm1",
            category: "prevention",
            title: "Pre-Operative MRSA Screening",
            situation: "Sarah Martinez is scheduled for knee replacement surgery tomorrow. Hospital protocol requires MRSA screening for all orthopedic surgery patients. She transferred from a nursing home where an MRSA outbreak occurred last month.",
            labValues: "No current labs. Previous admission (6 months ago): Nasal swab negative for MRSA.",
            question: "What is the appropriate screening approach?",
            choices: [
              {
                text: "Skip screening - she was negative 6 months ago",
                outcome: "poor",
                healthImpact: 0,
                wardImpact: -15,
                xp: 10,
                feedback: "Previous negative screening doesn't predict current status, especially with nursing home exposure. Undetected MRSA colonization leads to 50% higher surgical site infection rates.",
                insight: "MRSA colonization status changes over time. Nursing home residents have 25-30% MRSA colonization rates. Pre-operative screening identifies candidates for decolonization, which reduces SSI by 50%."
              },
              {
                text: "Perform nasal PCR screening now; if positive, delay surgery for 5-day decolonization protocol",
                outcome: "optimal",
                healthImpact: 5,
                wardImpact: 10,
                xp: 50,
                feedback: "Excellent! Evidence-based approach. Rapid PCR provides results in 2-4 hours. Pre-operative decolonization dramatically reduces surgical site infections in colonized patients.",
                insight: "The 'search and destroy' strategy: screen ‚Üí decolonize ‚Üí operate. Studies show 5-day mupirocin + CHG protocol before surgery reduces MRSA SSI by 58%."
              },
              {
                text: "Screen but proceed with surgery regardless of results",
                outcome: "suboptimal",
                healthImpact: -5,
                wardImpact: -5,
                xp: 20,
                feedback: "Screening without acting on results wastes resources and misses prevention opportunity. If positive, proceeding without decolonization exposes her to higher infection risk.",
                insight: "Screening is only valuable if results guide action. MRSA-colonized patients have 2-9√ó higher SSI rates than non-colonized patients in orthopedic surgery."
              }
            ]
          }
        ]
      }
    ];

    // Initialize patient states
    for (let i = 0; i < patients.length; i++) {
      const p = patients[i];
      gameState.patientStates[p.id] = {
        health: p.baseHealth,
        scenarioIndex: 0,
        completed: false
      };
    }

    // Initialize SDK
    async function initializeApp() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig: defaultConfig,
          onConfigChange: async function(config) {
            document.getElementById('module-title').textContent = config.module_title || defaultConfig.module_title;
          },
          mapToCapabilities: function(config) {
            return {
              recolorables: [
                {
                  get: function() { return config.background_color || defaultConfig.background_color; },
                  set: function(value) { window.elementSdk.setConfig({ background_color: value }); }
                },
                {
                  get: function() { return config.primary_color || defaultConfig.primary_color; },
                  set: function(value) { window.elementSdk.setConfig({ primary_color: value }); }
                },
                {
                  get: function() { return config.text_color || defaultConfig.text_color; },
                  set: function(value) { window.elementSdk.setConfig({ text_color: value }); }
                },
                {
                  get: function() { return config.accent_color || defaultConfig.accent_color; },
                  set: function(value) { window.elementSdk.setConfig({ accent_color: value }); }
                }
              ],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            };
          },
          mapToEditPanelValues: function(config) {
            return new Map([
              ["module_title", config.module_title || defaultConfig.module_title]
            ]);
          }
        });
      }
      
      renderPatientList();
      updateXPDisplay();
      updateStats();
      updateInfectionSpread();
    }

    function renderPatientList() {
      const container = document.getElementById('patient-list');
      let html = '';
      
      for (let i = 0; i < patients.length; i++) {
        const patient = patients[i];
        const state = gameState.patientStates[patient.id];
        const totalScenarios = patient.scenarios.length;
        const completed = state.scenarioIndex >= totalScenarios;
        
        const riskColorMap = {
          'low': 'border-emerald-400 bg-emerald-900/30',
          'moderate': 'border-amber-400 bg-amber-900/30',
          'high': 'border-red-400 bg-red-900/30'
        };
        const riskColor = riskColorMap[patient.riskLevel];
        
        const isActive = gameState.currentPatientId === patient.id;
        const activeClass = isActive ? 'active' : '';
        
        const statusColorMap = {
          'high': 'text-red-400',
          'moderate': 'text-amber-400',
          'low': 'text-emerald-400'
        };
        const statusColor = statusColorMap[patient.riskLevel];
        
        html += '<div onclick="selectPatient(' + patient.id + ')" ' +
          'class="patient-card p-3 rounded-xl border-2 ' + riskColor + ' ' + activeClass + ' mb-2 hover:shadow-lg transition-all">' +
          '<div class="flex items-start justify-between mb-2">' +
          '<div>' +
          '<h3 class="font-bold text-white text-sm">' + patient.name + '</h3>' +
          '<p class="text-xs text-slate-400">Age ' + patient.age + ' ‚Ä¢ Room ' + patient.room + '</p>' +
          '</div>' +
          (completed ? '<span class="text-emerald-400 text-xl">‚úì</span>' : '') +
          '</div>' +
          '<p class="text-xs text-slate-300 mb-2">' + patient.admission + '</p>' +
          '<div class="flex items-center justify-between">' +
          '<span class="text-xs font-bold ' + statusColor + '">' + patient.mrsaStatus + '</span>' +
          '<span class="text-xs text-slate-400 font-semibold">' + state.scenarioIndex + '/' + totalScenarios + '</span>' +
          '</div>' +
          '</div>';
      }
      
      container.innerHTML = html;
    }

    function selectPatient(patientId) {
      gameState.currentPatientId = patientId;
      gameState.currentScenarioIndex = gameState.patientStates[patientId].scenarioIndex;
      renderPatientList();
      renderScenario();
      
      let patient = null;
      for (let i = 0; i < patients.length; i++) {
        if (patients[i].id === patientId) {
          patient = patients[i];
          break;
        }
      }
      updateVitalsDisplay(patient);
      updatePatientStatusDisplay(patient);
    }

    function renderScenario() {
      let patient = null;
      for (let i = 0; i < patients.length; i++) {
        if (patients[i].id === gameState.currentPatientId) {
          patient = patients[i];
          break;
        }
      }
      if (!patient) return;
      
      const state = gameState.patientStates[patient.id];
      const container = document.getElementById('scenario-container');
      
      document.getElementById('patient-name-display').textContent = patient.name;
      document.getElementById('patient-details').textContent = 'Age ' + patient.age + ' ‚Ä¢ Room ' + patient.room + ' ‚Ä¢ ' + patient.admission;
      document.getElementById('patient-status-badge').textContent = patient.mrsaStatus;
      document.getElementById('health-percent').textContent = state.health + '%';
      document.getElementById('health-bar').style.width = state.health + '%';
      document.getElementById('scenario-progress').textContent = (state.scenarioIndex + 1) + ' / ' + patient.scenarios.length;
      document.getElementById('ward-safety-header').textContent = gameState.wardSafety + '%';
      
      const healthBar = document.getElementById('health-bar');
      if (state.health > 70) {
        healthBar.className = 'health-bar-fill h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full';
      } else if (state.health > 40) {
        healthBar.className = 'health-bar-fill h-full bg-gradient-to-r from-amber-400 to-orange-500 rounded-full';
      } else {
        healthBar.className = 'health-bar-fill h-full bg-gradient-to-r from-red-500 to-pink-600 rounded-full';
      }
      
      if (state.scenarioIndex >= patient.scenarios.length) {
        container.innerHTML = '<div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-2xl border-2 border-yellow-400 p-12 text-center relative overflow-hidden">' +
          '<div class="absolute inset-0 bg-black opacity-20"></div>' +
          '<div class="relative z-10">' +
          '<div class="w-20 h-20 bg-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl">' +
          '<svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' +
          '</svg>' +
          '</div>' +
          '<h2 class="text-2xl font-black text-white mb-2 drop-shadow-lg">Patient Complete!</h2>' +
          '<p class="text-white text-lg mb-4 font-semibold">All scenarios completed for ' + patient.name + '</p>' +
          '<p class="text-green-100 text-sm">Select another patient to continue training!</p>' +
          '</div>' +
          '</div>';
        checkModuleCompletion();
        return;
      }
      
      const scenario = patient.scenarios[state.scenarioIndex];
      const categoryColorMap = {
        'prevention': 'from-purple-600 to-indigo-700',
        'identification': 'from-pink-600 to-red-600',
        'treatment': 'from-blue-600 to-cyan-600'
      };
      const categoryColor = categoryColorMap[scenario.category];
      
      let choicesHtml = '';
      for (let i = 0; i < scenario.choices.length; i++) {
        const choice = scenario.choices[i];
        const letter = String.fromCharCode(65 + i);
        choicesHtml += '<button onclick="makeDecision(' + i + ')" ' +
          'class="decision-btn w-full text-left p-4 rounded-xl border-2 border-slate-600 bg-slate-700 hover:border-purple-500 hover:bg-slate-600 transition-all shadow-lg">' +
          '<div class="flex items-start gap-3">' +
          '<span class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-sm font-bold text-white shadow-lg">' +
          letter +
          '</span>' +
          '<span class="text-slate-200 font-medium">' + choice.text + '</span>' +
          '</div>' +
          '</button>';
      }
      
      container.innerHTML = '<div class="bg-slate-800 rounded-2xl shadow-2xl border-2 border-slate-600 overflow-hidden">' +
        '<div class="bg-gradient-to-r ' + categoryColor + ' px-6 py-4 relative overflow-hidden">' +
        '<div class="absolute inset-0 bg-black opacity-20"></div>' +
        '<div class="relative z-10">' +
        '<div class="flex items-center justify-between mb-2">' +
        '<div class="flex items-center gap-2 text-white text-sm">' +
        '<span class="font-semibold">' + patient.name + '</span>' +
        '<span>‚Ä¢</span>' +
        '<span>Scenario ' + (state.scenarioIndex + 1) + '/' + patient.scenarios.length + '</span>' +
        '</div>' +
        '<span class="category-badge ' + scenario.category + '">' + scenario.category.toUpperCase() + '</span>' +
        '</div>' +
        '<h2 class="text-2xl font-black text-white drop-shadow-lg">' + scenario.title + '</h2>' +
        '</div>' +
        '</div>' +
        '<div class="p-6 border-b-2 border-slate-700">' +
        '<h3 class="text-xs font-bold text-purple-400 uppercase tracking-wider mb-2">üìã Clinical Situation</h3>' +
        '<p class="text-slate-300 leading-relaxed">' + scenario.situation + '</p>' +
        '</div>' +
        '<div class="px-6 py-4 bg-slate-700 border-b-2 border-slate-600">' +
        '<h3 class="text-xs font-bold text-cyan-400 uppercase tracking-wider mb-2">üî¨ Lab Values & Data</h3>' +
        '<p class="text-sm text-slate-300 font-mono bg-slate-800 p-3 rounded-lg border border-slate-600">' + scenario.labValues + '</p>' +
        '</div>' +
        '<div class="p-6 border-b-2 border-slate-700 bg-gradient-to-br from-slate-800 to-slate-700">' +
        '<h3 class="text-xs font-bold text-yellow-400 uppercase tracking-wider mb-2">‚ùì Clinical Question</h3>' +
        '<p class="text-white font-bold text-lg">' + scenario.question + '</p>' +
        '</div>' +
        '<div class="p-6 space-y-3">' +
        choicesHtml +
        '</div>' +
        '</div>';
    }

    function makeDecision(choiceIndex) {
      let patient = null;
      for (let i = 0; i < patients.length; i++) {
        if (patients[i].id === gameState.currentPatientId) {
          patient = patients[i];
          break;
        }
      }
      const state = gameState.patientStates[patient.id];
      const scenario = patient.scenarios[state.scenarioIndex];
      const choice = scenario.choices[choiceIndex];
      
      gameState.lastDecision = {
        patientId: patient.id,
        scenarioIndex: state.scenarioIndex,
        choiceIndex: choiceIndex,
        previousHealth: state.health,
        previousWard: gameState.wardSafety,
        previousXP: gameState.xp
      };
      
      state.health = Math.max(0, Math.min(100, state.health + choice.healthImpact));
      gameState.wardSafety = Math.max(0, Math.min(100, gameState.wardSafety + choice.wardImpact));
      
      const isOptimal = choice.outcome === 'optimal';
      addXP(choice.xp);
      updateStreak(isOptimal);
      
      gameState.decisions.push({
        patient: patient.name,
        scenario: scenario.title,
        outcome: choice.outcome
      });
      
      updateStats();
      updateInfectionSpread();
      updateVitalsDisplay(patient);
      updatePatientStatusDisplay(patient);
      showFeedbackModal(choice, scenario.title, patient.name);
    }

    function showFeedbackModal(choice, scenarioTitle, patientName) {
      const modal = document.getElementById('feedback-modal');
      const header = document.getElementById('modal-header');
      const title = document.getElementById('modal-title');
      const message = document.getElementById('modal-message');
      const insight = document.getElementById('modal-insight');
      const undoBtn = document.getElementById('undo-btn');
      const xpGain = document.getElementById('modal-xp-gain');
      const xpEarned = document.getElementById('xp-earned');
      
      const outcomeConfig = {
        'optimal': { 
          color: 'bg-gradient-to-r from-green-500 to-emerald-600 border-green-400', 
          titleColor: 'text-white',
          icon: '‚úì',
          label: 'Optimal Decision!'
        },
        'suboptimal': { 
          color: 'bg-gradient-to-r from-amber-500 to-orange-600 border-amber-400', 
          titleColor: 'text-white',
          icon: '‚ö†',
          label: 'Suboptimal Decision'
        },
        'poor': { 
          color: 'bg-gradient-to-r from-red-500 to-pink-600 border-red-400', 
          titleColor: 'text-white',
          icon: '‚úó',
          label: 'Poor Decision'
        }
      };
      
      const config = outcomeConfig[choice.outcome];
      header.className = 'p-5 border-b-2 ' + config.color;
      title.className = 'text-xl font-bold ' + config.titleColor + ' drop-shadow-lg';
      title.textContent = config.icon + ' ' + config.label;
      message.textContent = choice.feedback;
      insight.textContent = choice.insight;
      
      xpEarned.textContent = choice.xp;
      xpGain.classList.remove('hidden');
      
      undoBtn.style.display = choice.outcome !== 'optimal' ? 'block' : 'none';
      
      modal.classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('feedback-modal').classList.add('hidden');
      
      let patient = null;
      for (let i = 0; i < patients.length; i++) {
        if (patients[i].id === gameState.currentPatientId) {
          patient = patients[i];
          break;
        }
      }
      const state = gameState.patientStates[patient.id];
      state.scenarioIndex++;
      
      renderPatientList();
      renderScenario();
      updateVitalsDisplay(patient);
      updatePatientStatusDisplay(patient);
    }

    function undoDecision() {
      if (!gameState.lastDecision) return;
      
      const state = gameState.patientStates[gameState.lastDecision.patientId];
      state.health = gameState.lastDecision.previousHealth;
      gameState.wardSafety = gameState.lastDecision.previousWard;
      gameState.xp = gameState.lastDecision.previousXP;
      gameState.decisions.pop();
      gameState.streak = Math.max(0, gameState.streak - 1);
      
      document.getElementById('feedback-modal').classList.add('hidden');
      updateXPDisplay();
      updateStats();
      updateInfectionSpread();
      document.getElementById('streak-count').textContent = gameState.streak;
      renderPatientList();
      renderScenario();
      
      let patient = null;
      for (let i = 0; i < patients.length; i++) {
        if (patients[i].id === gameState.lastDecision.patientId) {
          patient = patients[i];
          break;
        }
      }
      updateVitalsDisplay(patient);
      updatePatientStatusDisplay(patient);
      
      showToast('‚Ü© Decision undone - try again!', 'info');
      gameState.lastDecision = null;
    }

    function checkModuleCompletion() {
      let allComplete = true;
      for (let i = 0; i < patients.length; i++) {
        const patient = patients[i];
        const state = gameState.patientStates[patient.id];
        if (state.scenarioIndex < patient.scenarios.length) {
          allComplete = false;
          break;
        }
      }
      
      if (allComplete) {
        setTimeout(function() { showCompletionModal(); }, 1000);
      }
    }

    function showCompletionModal() {
      const modal = document.getElementById('completion-modal');
      let optimalCount = 0;
      for (let i = 0; i < gameState.decisions.length; i++) {
        if (gameState.decisions[i].outcome === 'optimal') {
          optimalCount++;
        }
      }
      
      document.getElementById('final-ward-safety').textContent = gameState.wardSafety + '%';
      document.getElementById('optimal-decisions').textContent = optimalCount;
      document.getElementById('final-xp').textContent = gameState.xp;
      
      let rank = 'Novice';
      let summary = '';
      
      const successRate = (optimalCount / gameState.decisions.length) * 100;
      
      if (gameState.wardSafety >= 90 && successRate >= 80) {
        rank = 'MRSA Master';
        summary = 'üèÜ Outstanding! You achieved mastery in MRSA prevention, identification, and treatment. Ward safety is exceptional!';
      } else if (gameState.wardSafety >= 75 && successRate >= 60) {
        rank = 'Clinical Expert';
        summary = '‚≠ê Great work! Strong understanding of MRSA protocols. Minor improvements will perfect your technique.';
      } else if (gameState.wardSafety >= 60) {
        rank = 'Competent Clinician';
        summary = '‚úì Good effort! You understand the basics. Review suboptimal scenarios to improve patient outcomes.';
      } else {
        rank = 'Novice';
        summary = 'üìö Ward safety needs improvement. Review prevention protocols and practice identifying early infection signs.';
      }
      
      document.getElementById('rank-text').textContent = rank;
      document.getElementById('completion-summary').textContent = summary;
      modal.classList.remove('hidden');
    }

    function resetModule() {
      gameState = {
        currentPatientId: null,
        currentScenarioIndex: 0,
        wardSafety: 90,
        patientStates: {},
        decisions: [],
        lastDecision: null,
        xp: 0,
        level: 1,
        streak: 0,
        achievements: []
      };
      
      for (let i = 0; i < patients.length; i++) {
        const p = patients[i];
        gameState.patientStates[p.id] = {
          health: p.baseHealth,
          scenarioIndex: 0,
          completed: false
        };
      }
      
      document.getElementById('completion-modal').classList.add('hidden');
      document.getElementById('feedback-modal').classList.add('hidden');
      
      document.getElementById('scenario-container').innerHTML = '<div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl shadow-2xl border-2 border-yellow-400 p-12 text-center relative overflow-hidden">' +
        '<div class="absolute inset-0 bg-black opacity-20"></div>' +
        '<div class="relative z-10">' +
        '<div class="w-24 h-24 bg-gradient-to-br from-yellow-300 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl">' +
        '<svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>' +
        '</svg>' +
        '</div>' +
        '<h2 class="text-3xl font-black text-white mb-4 drop-shadow-lg">MRSA Combat Training</h2>' +
        '<p class="text-white text-lg mb-6 max-w-xl mx-auto font-medium">Select a patient from the left to start your clinical mission. Master prevention, identification, and treatment protocols to save lives and earn XP!</p>' +
        '<div class="inline-block px-8 py-4 bg-black/30 backdrop-blur-sm border-2 border-yellow-400 rounded-xl">' +
        '<p class="text-lg text-yellow-300 font-bold">üè• 5 Patients ‚Ä¢ üéØ Multiple Scenarios ‚Ä¢ üèÜ Earn XP & Streaks</p>' +
        '</div>' +
        '</div>' +
        '</div>';
      
      updateVitalsDisplay(null);
      updatePatientStatusDisplay(null);
      updateXPDisplay();
      updateStats();
      updateInfectionSpread();
      renderPatientList();
      showToast('üîÑ Training module reset - good luck!', 'info');
    }

    function showToast(message, type) {
      const container = document.getElementById('toast-container');
      const colorMap = {
        'success': 'bg-gradient-to-r from-green-500 to-emerald-600',
        'warning': 'bg-gradient-to-r from-amber-500 to-orange-600',
        'error': 'bg-gradient-to-r from-red-500 to-pink-600',
        'info': 'bg-gradient-to-r from-blue-500 to-purple-600'
      };
      
      const toast = document.createElement('div');
      toast.className = 'toast ' + colorMap[type] + ' text-white px-5 py-3 rounded-xl shadow-2xl text-sm max-w-sm font-semibold border-2 border-white/20';
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(function() {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(function() { toast.remove(); }, 300);
      }, 4000);
    }

    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bc0849b37e61c5f',t:'MTc2ODA5MzY1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
